import React, { useState, useEffect } from 'react';
import { Calculator, TrendingUp, Calendar, DollarSign, AlertCircle } from 'lucide-react';

const CalculadoraAtualizacao = () => {
  const [valorPrincipal, setValorPrincipal] = useState('10000');
  const [dataInicial, setDataInicial] = useState('2021-01');
  const [dataFinal, setDataFinal] = useState('2024-03');
  const [tipoDevedor, setTipoDevedor] = useState('fazenda');
  const [tipoAcao, setTipoAcao] = useState('condenatoria');
  const [resultado, setResultado] = useState(null);
  const [carregando, setCarregando] = useState(false);

  // Dados hist√≥ricos simulados (em aplica√ß√£o real, viriam das APIs)
  const indicesHistoricos = {
    'selic': {
      '2021-12': 0.9249, '2022-01': 0.9340, '2022-02': 0.9320, '2022-03': 1.0021,
      '2022-04': 0.9905, '2022-05': 1.0657, '2022-06': 1.1059, '2022-07': 1.0970,
      '2022-08': 1.1628, '2022-09': 1.0881, '2022-10': 1.0970, '2022-11': 1.0165,
      '2022-12': 1.1309, '2023-01': 1.0461, '2023-02': 0.9436, '2023-03': 1.1113,
      '2023-04': 0.9710, '2023-05': 1.0266, '2023-06': 1.0559, '2023-07': 1.0853,
      '2023-08': 1.0755, '2023-09': 1.0363, '2023-10': 0.9808, '2023-11': 0.8883,
      '2023-12': 0.9641, '2024-01': 0.8786, '2024-02': 0.7730, '2024-03': 0.8687
    },
    'ipca-e': {
      '2021-11': 1.17, '2021-12': 0.78, '2022-01': 0.63, '2022-02': 0.99,
      '2022-03': 1.62, '2022-04': 1.06, '2022-05': 0.59, '2022-06': 0.78,
      '2022-07': -0.68, '2022-08': -0.36, '2022-09': -0.37, '2022-10': 0.16,
      '2022-11': 0.53, '2022-12': 0.62, '2023-01': 0.56, '2023-02': 0.84,
      '2023-03': 0.71, '2023-04': 0.57, '2023-05': 0.48, '2023-06': 0.05,
      '2023-07': 0.12, '2023-08': 0.23, '2023-09': 0.35, '2023-10': 0.21,
      '2023-11': 0.30, '2023-12': 0.48, '2024-01': 0.34, '2024-02': 0.82, '2024-03': 0.33
    },
    'inpc': {
      '2021-11': 0.95, '2021-12': 0.78, '2022-01': 0.63, '2022-02': 1.01,
      '2022-03': 1.62, '2022-04': 1.01, '2022-05': 0.65, '2022-06': 0.75,
      '2022-07': 0.02, '2022-08': -0.35, '2022-09': -0.29, '2022-10': 0.14,
      '2022-11': 0.41, '2022-12': 0.56, '2023-01': 0.52, '2023-02': 0.83,
      '2023-03': 0.61, '2023-04': 0.49, '2023-05': 0.42, '2023-06': -0.04,
      '2023-07': 0.07, '2023-08': 0.10, '2023-09': 0.27, '2023-10': 0.17,
      '2023-11': 0.27, '2023-12': 0.51, '2024-01': 0.42, '2024-02': 0.84, '2024-03': 0.38
    }
  };

  const calcularAtualizacao = () => {
    setCarregando(true);
    
    setTimeout(() => {
      const valor = parseFloat(valorPrincipal.replace(/\./g, '').replace(',', '.'));
      let valorAtualizado = valor;
      let detalhamento = [];
      
      const dataIni = new Date(dataInicial + '-01');
      const dataFim = new Date(dataFinal + '-01');
      
      // Determinar indexador conforme regras do manual
      let indexador = 'ipca-e';
      let taxaJuros = 0.5; // 0,5% ao m√™s padr√£o
      
      if (tipoDevedor === 'fazenda') {
        // Ap√≥s dez/2021, Fazenda P√∫blica usa SELIC
        if (dataIni >= new Date('2021-12-01')) {
          indexador = 'selic';
        }
        // Entre maio/2012 e nov/2021: juros da poupan√ßa
        if (dataIni >= new Date('2012-05-01') && dataIni <= new Date('2021-11-01')) {
          taxaJuros = 0.5; // Simplificado
        }
      }
      
      if (tipoAcao === 'previdenciaria') {
        indexador = 'inpc';
        if (dataIni >= new Date('2021-12-01')) {
          indexador = 'selic';
        }
      }
      
      // Calcular atualiza√ß√£o m√™s a m√™s
      let dataAtual = new Date(dataIni);
      while (dataAtual <= dataFim) {
        const mesAno = `${dataAtual.getFullYear()}-${String(dataAtual.getMonth() + 1).padStart(2, '0')}`;
        
        let indice = 0;
        if (indexador === 'selic') {
          indice = indicesHistoricos.selic[mesAno] || 0;
          // SELIC j√° inclui corre√ß√£o + juros
          valorAtualizado = valorAtualizado * (1 + indice / 100);
          detalhamento.push({
            mes: mesAno,
            tipo: 'SELIC',
            percentual: indice.toFixed(4) + '%',
            valor: valorAtualizado
          });
        } else {
          const correcao = indicesHistoricos[indexador][mesAno] || 0;
          valorAtualizado = valorAtualizado * (1 + correcao / 100);
          
          // Aplicar juros separadamente
          const juros = valorAtualizado * (taxaJuros / 100);
          valorAtualizado += juros;
          
          detalhamento.push({
            mes: mesAno,
            tipo: indexador.toUpperCase() + ' + Juros',
            percentual: correcao.toFixed(2) + '% + ' + taxaJuros + '%',
            valor: valorAtualizado
          });
        }
        
        dataAtual.setMonth(dataAtual.getMonth() + 1);
      }
      
      setResultado({
        valorOriginal: valor,
        valorAtualizado: valorAtualizado,
        correcao: valorAtualizado - valor,
        percentualTotal: ((valorAtualizado - valor) / valor * 100),
        detalhamento: detalhamento.slice(-6), // √öltimos 6 meses
        indexadorUsado: indexador.toUpperCase()
      });
      
      setCarregando(false);
    }, 500);
  };

  useEffect(() => {
    if (valorPrincipal && dataInicial && dataFinal) {
      calcularAtualizacao();
    }
  }, [valorPrincipal, dataInicial, dataFinal, tipoDevedor, tipoAcao]);

  const formatarMoeda = (valor) => {
    return new Intl.NumberFormat('pt-BR', {
      style: 'currency',
      currency: 'BRL'
    }).format(valor);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-4">
      <div className="max-w-6xl mx-auto">
        {/* Header */}
        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
          <div className="flex items-center gap-3 mb-2">
            <Calculator className="w-8 h-8 text-blue-600" />
            <h1 className="text-3xl font-bold text-gray-800">
              Calculadora de Atualiza√ß√£o Monet√°ria
            </h1>
          </div>
          <p className="text-gray-600">
            Baseada no Manual de C√°lculos da Justi√ßa Federal - 2025
          </p>
        </div>

        <div className="grid md:grid-cols-2 gap-6">
          {/* Painel de Entrada */}
          <div className="bg-white rounded-lg shadow-lg p-6">
            <h2 className="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
              <DollarSign className="w-5 h-5" />
              Dados do C√°lculo
            </h2>

            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Valor Principal (R$)
                </label>
                <input
                  type="text"
                  value={valorPrincipal}
                  onChange={(e) => setValorPrincipal(e.target.value)}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="10.000,00"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Data Inicial
                </label>
                <input
                  type="month"
                  value={dataInicial}
                  onChange={(e) => setDataInicial(e.target.value)}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Data Final
                </label>
                <input
                  type="month"
                  value={dataFinal}
                  onChange={(e) => setDataFinal(e.target.value)}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Tipo de Devedor
                </label>
                <select
                  value={tipoDevedor}
                  onChange={(e) => setTipoDevedor(e.target.value)}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="fazenda">Fazenda P√∫blica</option>
                  <option value="particular">Particular/Empresa</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Tipo de A√ß√£o
                </label>
                <select
                  value={tipoAcao}
                  onChange={(e) => setTipoAcao(e.target.value)}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="condenatoria">Condenat√≥ria Geral</option>
                  <option value="previdenciaria">Benef√≠cio Previdenci√°rio</option>
                  <option value="desapropriacao">Desapropria√ß√£o</option>
                  <option value="tributaria">Repeti√ß√£o de Ind√©bito</option>
                </select>
              </div>
            </div>

            <div className="mt-6 p-4 bg-blue-50 rounded-lg">
              <div className="flex items-start gap-2">
                <AlertCircle className="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" />
                <div className="text-sm text-blue-800">
                  <strong>Nota:</strong> A partir de dez/2021, a Fazenda P√∫blica utiliza 
                  SELIC (que engloba corre√ß√£o + juros). Antes disso, IPCA-E + juros separados.
                </div>
              </div>
            </div>
          </div>

          {/* Painel de Resultados */}
          <div className="bg-white rounded-lg shadow-lg p-6">
            <h2 className="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
              <TrendingUp className="w-5 h-5" />
              Resultado
            </h2>

            {carregando ? (
              <div className="flex items-center justify-center h-64">
                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
              </div>
            ) : resultado ? (
              <div className="space-y-4">
                <div className="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-6 text-white">
                  <div className="text-sm opacity-90 mb-1">Valor Atualizado</div>
                  <div className="text-3xl font-bold">
                    {formatarMoeda(resultado.valorAtualizado)}
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div className="bg-gray-50 rounded-lg p-4">
                    <div className="text-xs text-gray-600 mb-1">Valor Original</div>
                    <div className="text-lg font-semibold text-gray-800">
                      {formatarMoeda(resultado.valorOriginal)}
                    </div>
                  </div>
                  <div className="bg-green-50 rounded-lg p-4">
                    <div className="text-xs text-gray-600 mb-1">Corre√ß√£o Total</div>
                    <div className="text-lg font-semibold text-green-600">
                      {formatarMoeda(resultado.correcao)}
                    </div>
                  </div>
                </div>

                <div className="bg-purple-50 rounded-lg p-4">
                  <div className="text-xs text-gray-600 mb-1">Percentual de Corre√ß√£o</div>
                  <div className="text-2xl font-bold text-purple-600">
                    {resultado.percentualTotal.toFixed(2)}%
                  </div>
                  <div className="text-xs text-gray-600 mt-1">
                    Indexador: {resultado.indexadorUsado}
                  </div>
                </div>

                {/* Detalhamento */}
                <div className="mt-6">
                  <h3 className="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                    <Calendar className="w-4 h-4" />
                    √öltimos 6 Meses
                  </h3>
                  <div className="space-y-2 max-h-64 overflow-y-auto">
                    {resultado.detalhamento.map((item, index) => (
                      <div key={index} className="bg-gray-50 rounded p-3 text-sm">
                        <div className="flex justify-between items-center mb-1">
                          <span className="font-medium text-gray-700">{item.mes}</span>
                          <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">
                            {item.tipo}
                          </span>
                        </div>
                        <div className="flex justify-between items-center text-xs">
                          <span className="text-gray-600">{item.percentual}</span>
                          <span className="font-semibold text-gray-800">
                            {formatarMoeda(item.valor)}
                          </span>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            ) : (
              <div className="flex items-center justify-center h-64 text-gray-400">
                Preencha os dados para calcular
              </div>
            )}
          </div>
        </div>

        {/* Informa√ß√µes sobre APIs */}
        <div className="mt-6 bg-white rounded-lg shadow-lg p-6">
          <h3 className="text-lg font-semibold text-gray-800 mb-4">
            üì° APIs P√∫blicas para Dados Reais
          </h3>
          <div className="grid md:grid-cols-2 gap-4">
            <div className="bg-slate-50 rounded p-4">
              <h4 className="font-semibold text-gray-700 mb-2">Banco Central (SELIC)</h4>
              <code className="text-xs bg-white p-2 rounded block overflow-x-auto">
                https://api.bcb.gov.br/dados/serie/bcdata.sgs.11/dados
              </code>
            </div>
            <div className="bg-slate-50 rounded p-4">
              <h4 className="font-semibold text-gray-700 mb-2">IBGE (IPCA/INPC)</h4>
              <code className="text-xs bg-white p-2 rounded block overflow-x-auto">
                https://servicodados.ibge.gov.br/api/v3/agregados/
              </code>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default CalculadoraAtualizacao;